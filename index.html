<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<title>OnURL.space</title>

<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
<link rel="manifest" href="assets/site.webmanifest">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
  rel="stylesheet">
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* Custom Persistent Scrollbar */
  ::-webkit-scrollbar {
    width: 14px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background-color: var(--ce-scrollbar-thumb);
    border: 4px solid transparent;
    background-clip: content-box;
    border-radius: 99px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background-color: var(--text);
  }

  :root {
    --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', monospace;

    --bg-light: #f0eee6;
    --bg-dark: #0d1117;

    --elevated-light: rgba(255, 255, 255, 0.85);
    --elevated-dark: rgba(22, 27, 34, 0.85);
    /* #161b22 */

    --text-light: #141413;
    --text-dark: #FAF9F5;

    --link-light: #0969da;
    --link-dark: #58a6ff;

    --outline-color: #0969da;

    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);

    /* UI Colors - Light */
    --primary: #d97757;
    --bg-hover: rgba(0, 0, 0, 0.04);
    --menu-button-bg: #d1cec7;
    --toolbar-active-bg: #d1cec7;
    --toolbar-active-text: #141413;

    /* Code Editor Output - Light */
    --ce-output-bg: #f6f8fa;
    --ce-output-text: #24292f;
    --ce-output-border: #e1e4e8;
    --ce-output-header-bg: #f1f3f5;

    /* Code Editor Syntex Highlighting - Light */
    --ce-keyword: #cf222e;
    --ce-string: #0a3069;
    --ce-number: #0550ae;
    --ce-comment: #6e7781;
    --ce-function: #8250df;
    --ce-operator: #cf222e;
    --ce-builtin: #953800;
    --ce-regex: #116329;
    --ce-tag: #116329;
    --ce-selector: #8250df;
    --ce-variable: #953800;
    --ce-heading: #0550ae;
    --ce-link: #0969da;
    --ce-bg: #fdfcfa;
    --ce-border: #e1e4e8;
    --ce-header-bg: #f1f3f5;
    --ce-scrollbar-track: transparent;
    --ce-scrollbar-thumb: #d0d7de;
  }

  html {
    color-scheme: light dark;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    font-family: var(--font-sans);

    background-color: var(--bg-light);
    --elevated: var(--elevated-light);
    --link: var(--link-light);
    --text: var(--text-light);
    --outline: var(--outline-color);

    transition: background-color 0.3s ease, color 0.3s ease;
    scrollbar-gutter: stable;
    overflow-y: scroll;

    /* Theme defaults based on system preference */
    @media (prefers-color-scheme: dark) {
      background-color: var(--bg-dark);
      --elevated: var(--elevated-dark);
      --link: var(--link-dark);
      --text: var(--text-dark);

      /* UI Colors - Dark System Default */
      --primary: #0f7c11;
      --bg-hover: #353535;
      --menu-button-bg: #0969da;
      --toolbar-active-bg: #0569fa;
      --toolbar-active-text: #fff;

      /* Code Editor Output - Dark System Default */
      --ce-output-bg: #161b22;
      --ce-output-text: #c9d1d9;
      --ce-output-border: #30363d;
      --ce-output-header-bg: #21262d;

      /* Code Editor Syntax Highlighting - Dark System Default */
      --ce-keyword: #ff7b72;
      --ce-string: #a5d6ff;
      --ce-number: #79c0ff;
      --ce-comment: #8b949e;
      --ce-function: #d2a8ff;
      --ce-operator: #ff7b72;
      --ce-builtin: #ffa657;
      --ce-regex: #7ee787;
      --ce-tag: #7ee787;
      --ce-selector: #d2a8ff;
      --ce-variable: #ffa657;
      --ce-heading: #79c0ff;
      --ce-link: #58a6ff;
      --ce-bg: #161b22;
      --ce-border: #30363d;
      --ce-header-bg: #21262d;
      --ce-scrollbar-thumb: #484f58;
    }
  }

  /* Manual Theme Overrides */
  html[data-theme="light"] {
    background-color: var(--bg-light);
    --elevated: var(--elevated-light);
    --link: var(--link-light);
    --text: var(--text-light);
    color-scheme: light;

    /* UI Colors - Light Override */
    --primary: #d97757;
    --bg-hover: rgba(0, 0, 0, 0.04);
    --menu-button-bg: #d1cec7;
    --toolbar-active-bg: #d1cec7;
    --toolbar-active-text: #141413;

    /* Code Editor Output - Light Override */
    --ce-output-bg: #f6f8fa;
    --ce-output-text: #24292f;
    --ce-output-border: #e1e4e8;
    --ce-output-header-bg: #f1f3f5;

    /* Code Editor Syntex Highlighting - Light Override */
    --ce-keyword: #cf222e;
    --ce-string: #0a3069;
    --ce-number: #0550ae;
    --ce-comment: #6e7781;
    --ce-function: #8250df;
    --ce-operator: #cf222e;
    --ce-builtin: #953800;
    --ce-regex: #116329;
    --ce-tag: #116329;
    --ce-selector: #8250df;
    --ce-variable: #953800;
    --ce-heading: #0a4991;
    --ce-link: #0969da;
    --ce-bg: #fdfcfa;
    --ce-border: #e1e4e8;
    --ce-header-bg: #f1f3f5;
    --ce-scrollbar-thumb: #d0d7de;
  }

  html[data-theme="dark"] {
    background-color: var(--bg-dark);
    --elevated: var(--elevated-dark);
    --link: var(--link-dark);
    --text: var(--text-dark);
    color-scheme: dark;

    /* UI Colors - Dark Override */
    --primary: #0f7c11;
    --bg-hover: #353535;
    --menu-button-bg: #0969da;
    --toolbar-active-bg: #0569fa;
    --toolbar-active-text: #fff;

    /* Code Editor Output - Dark Override */
    --ce-output-bg: #161b22;
    --ce-output-text: #c9d1d9;
    --ce-output-border: #30363d;
    --ce-output-header-bg: #21262d;

    /* Code Editor Syntax Highlighting - Dark Override */
    --ce-keyword: #ff7b72;
    --ce-string: #a5d6ff;
    --ce-number: #79c0ff;
    --ce-comment: #8b949e;
    --ce-function: #d2a8ff;
    --ce-operator: #ff7b72;
    --ce-builtin: #ffa657;
    --ce-regex: #7ee787;
    --ce-tag: #7ee787;
    --ce-selector: #d2a8ff;
    --ce-variable: #ffa657;
    --ce-heading: #79c0ff;
    --ce-link: #58a6ff;
    --ce-bg: #161b22;
    --ce-border: #30363d;
    --ce-header-bg: #21262d;
    --ce-scrollbar-thumb: #484f58;
  }

  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
  }

  body {
    color: var(--text);
  }

  a {
    color: var(--link);
    text-decoration: underline;
    text-underline-offset: 4px;
    text-decoration-thickness: 1px;
  }

  article {
    outline: none;
    padding: 32px max(24px, calc(50vw - 400px));
    width: 100%;
    min-height: 100dvh;
    font-family: var(--font-sans);
    font-size: 17px;
    line-height: 1.6;
    tab-size: 4;
    white-space: pre-wrap;
    text-wrap-style: stable;
    overflow-wrap: break-word;
    animation: fadeIn 0.4s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Typography enhancements */
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    line-height: 1.25;
  }

  p,
  ul,
  ol {
    margin-bottom: 1em;
  }

  .md-h1,
  .md-h2,
  .md-h3,
  .md-h4,
  .md-h5,
  .md-h6 {
    font-weight: 700;
  }

  .md-h1 {
    font-size: 2em;
  }

  .md-h2 {
    font-size: 1.5em;
  }

  .md-h3 {
    font-size: 1.25em;
  }

  .md-h4 {
    font-size: 1.1em;
  }

  .md-h5 {
    font-size: 1em;
  }

  .md-h6 {
    font-size: 0.9em;
  }

  .md-code {
    font-family: var(--font-mono);
    background-color: var(--ce-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .md-backtick {
    font-family: var(--font-mono);
    font-size: 0.9em;
  }

  .md-codeblock {
    font-family: var(--font-mono);
  }

  .md-bold {
    font-weight: bold;
  }

  .md-strike {
    text-decoration: line-through;
  }

  .md-italic {
    font-style: italic;
  }

  .md-url {
    cursor: pointer;
  }

  /* Code Editor syntax highlighting (extensible for all languages) */
  .ce-keyword {
    color: var(--ce-keyword);
  }

  .ce-string {
    color: var(--ce-string);
  }

  .ce-number {
    color: var(--ce-number);
  }

  .ce-comment {
    color: var(--ce-comment);
  }

  .ce-function {
    color: var(--ce-function);
  }

  .ce-operator {
    color: var(--ce-operator);
  }

  .ce-builtin {
    color: var(--ce-builtin);
  }

  .ce-regex {
    color: var(--ce-regex);
  }

  .ce-tag {
    color: var(--ce-tag);
  }

  .ce-selector {
    color: var(--ce-selector);
  }

  .ce-variable {
    color: var(--ce-variable);
  }

  .ce-heading {
    font-weight: bold;
    color: var(--ce-heading);
  }

  .ce-code {
    background: rgba(175, 184, 193, 0.2);
    padding: 2px 4px;
    border-radius: 3px;
  }

  .ce-bold {
    font-weight: bold;
  }

  .ce-italic {
    font-style: italic;
  }

  .ce-link {
    color: var(--ce-link);
  }

  /* Interactive Code Editor */
  .code-editor {
    display: block;
    margin: 12px 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--ce-border);
    background: var(--ce-bg);
  }

  .code-editor-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--ce-header-bg);
    border-bottom: 1px solid var(--ce-border);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .code-editor-lang {
    font-size: 12px;
    font-weight: 600;
    color: #57606a;
    text-transform: uppercase;
    letter-spacing: 0.5px;

    @media (prefers-color-scheme: dark) {
      color: #8b949e;
    }
  }

  .code-editor-lang-select {
    font-size: 12px;
    font-weight: 600;
    color: #57606a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    outline: none;
    font-family: var(--font-sans);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--elevated);
    box-shadow: var(--shadow-sm);

    @media (prefers-color-scheme: dark) {
      color: #c9d1d9;
      border-color: rgba(255, 255, 255, 0.1);
    }
  }

  .code-editor-lang-select:hover {
    background: var(--elevated);
    border-color: var(--outline);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);

    @media (prefers-color-scheme: dark) {
      border-color: var(--outline);
    }
  }

  .code-editor-lang-select:focus {
    border-color: var(--outline);
    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
  }

  .code-editor-lang-select option {
    text-transform: none;
    background: var(--elevated);
    color: var(--text);
  }

  .code-editor-actions {
    display: flex;
    gap: 6px;
  }

  .code-editor-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: var(--font-sans);
    box-shadow: var(--shadow-sm);
  }

  .code-editor-btn.copy {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #24292f;

    @media (prefers-color-scheme: dark) {
      background: #2d333b;
      border-color: rgba(255, 255, 255, 0.1);
      color: #c9d1d9;
    }
  }

  .code-editor-btn.copy:hover {
    background: #f6f8fa;
    box-shadow: var(--shadow-md);

    @media (prefers-color-scheme: dark) {
      background: #30363d;
    }
  }

  .code-editor-btn.run {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 1px 3px rgba(31, 136, 61, 0.2);
  }

  .code-editor-btn.run:hover {
    filter: brightness(1.1);
    box-shadow: 0 4px 8px rgba(31, 136, 61, 0.3);
  }

  .code-editor-btn svg {
    width: 14px;
    height: 14px;
  }

  .code-editor-body {
    position: relative;
  }

  .code-editor-textarea {
    display: block;
    width: 100%;
    min-height: 80px;
    padding: 12px;
    margin: 0;
    font-family: var(--font-mono);
    font-size: 14px;
    line-height: 1.5;
    tab-size: 2;
    border: none;
    outline: none;
    resize: none;
    background: transparent;
    color: transparent;
    caret-color: var(--text);
    white-space: pre;
    overflow: auto;
    position: relative;
    z-index: 1;
  }

  .code-editor-highlight {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 12px;
    margin: 0;
    font-family: var(--font-mono);
    font-size: 14px;
    line-height: 1.5;
    tab-size: 2;
    white-space: pre;
    pointer-events: none;
    overflow: auto;
    z-index: 0;
  }

  .code-editor-output {
    border-top: 1px solid var(--ce-output-border);
    background: var(--ce-output-bg);
    color: var(--ce-output-text);
  }

  .code-editor-output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--ce-output-text);
    background: var(--ce-output-header-bg);
    opacity: 0.8;
  }

  .code-editor-output-clear {
    background: none;
    border: none;
    color: #8b949e;
    cursor: pointer;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .code-editor-output-clear:hover {
    background: #30363d;
    color: #c9d1d9;
  }

  .code-editor-output-content {
    padding: 10px 12px;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.5;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .code-editor-output-content:empty::before {
    content: 'No output yet. Click Run to execute.';
    color: #6e7681;
    font-style: italic;
  }

  .code-editor-output-content .log {
    color: #c9d1d9;
  }

  .code-editor-output-content .error {
    color: #f85149;
  }

  .code-editor-output-content .warn {
    color: #d29922;
  }

  .code-editor-output-content .info {
    color: #58a6ff;
  }

  #toolbar {
    position: fixed;
    top: 12px;
    right: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 2;
  }

  .toolbar-btn {
    -webkit-tap-highlight-color: transparent;
    background-color: var(--elevated);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    color: var(--text);
    cursor: pointer;
    display: grid;
    width: 38px;
    height: 38px;
    outline: none;
    overflow: hidden;
    padding: 0;
    place-items: center;
    text-decoration: none;
    touch-action: manipulation;
    transition: background-color .2s ease-out, box-shadow .2s ease-out;
    user-select: none;

    /* Glassmorphism */
    background: var(--elevated);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(0, 0, 0, 0.06);
  }

  @media (hover) {
    .toolbar-btn:hover {
      background-color: rgba(0, 0, 0, 0.08);
    }

    @media (prefers-color-scheme: dark) {
      .toolbar-btn {
        border-color: rgba(255, 255, 255, 0.1);
      }

      .toolbar-btn:hover {
        background-color: rgba(255, 255, 255, 0.15);
      }
    }
  }

  .toolbar-btn:focus-visible {
    outline: 2px solid var(--outline);
    outline-offset: 2px;
  }

  .toolbar-btn.active {
    background-color: var(--toolbar-active-bg);
    color: var(--toolbar-active-text);
  }

  @media (hover) {
    .toolbar-btn.active:hover {
      filter: brightness(0.9);
    }
  }

  .toolbar-btn svg {
    width: 20px;
    height: 20px;
    transition: all 0.2s ease;
  }

  #button {
    -webkit-tap-highlight-color: transparent;
    background-color: var(--menu-button-bg);
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(9, 105, 218, 0.25);
    color: var(--text-light);
    cursor: pointer;
    display: grid;
    font-weight: 600;
    width: 38px;
    height: 38px;
    outline: none;
    overflow: hidden;
    padding: 0;
    place-items: center;
    text-decoration: none;
    touch-action: manipulation;
    transition: background-color .2s ease-out;
    user-select: none;
  }

  @media (hover) {
    #button:hover {
      filter: brightness(0.9);
    }
  }

  #button:focus-visible {
    outline: 2px solid var(--outline);
    outline-offset: 2px;
  }

  #button svg {
    width: 20px;
    height: 20px;
  }

  #menu {
    visibility: hidden;
    transform: scale(0.95) translateY(-10px);
    transform-origin: top right;
    transition: all 100ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    opacity: 0;
    display: flex;
    flex-direction: column;
    width: 200px;
    position: fixed;
    right: 12px;
    top: 56px;
    box-shadow: var(--shadow-lg);
    background: var(--elevated);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    z-index: 3;

    @media (prefers-color-scheme: dark) {
      border-color: rgba(255, 255, 255, 0.1);
    }
  }

  #menu.visible {
    opacity: 1;
    transform: scale(1) translateY(0);
    visibility: visible;
  }

  #menu .item {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    text-decoration: none;
    text-align: left;
    padding: 10px 14px;
    overflow: hidden;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    outline: none;
    border: none;
    touch-action: manipulation;
    font: 16px / 1.5 system-ui;
    color: var(--text);
  }

  #menu .item:hover {
    background-color: var(--bg-hover);
  }

  #menu .item:focus-within {
    outline: 2px solid var(--outline);
  }

  #menu .item:first-child {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }

  #menu .item svg {
    transition: all 0.2s ease;
  }

  #notification {
    visibility: hidden;
    transform: translateY(20px);
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    opacity: 0;

    display: flex;
    align-items: center;
    gap: 8px;

    position: fixed;
    right: 16px;
    bottom: 16px;

    background: var(--elevated);
    color: var(--text);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    font: 14px / 1.4 system-ui;
    font-weight: 500;
    z-index: 10;
    padding: 12px 16px;
    border: 1px solid rgba(0, 0, 0, 0.08);

    @media (prefers-color-scheme: dark) {
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
  }

  #notification.visible {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }

  #notification .toast-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  #notification.success {
    background: #dcfce7;
    color: #166534;
    border-color: #bbf7d0;

    @media (prefers-color-scheme: dark) {
      background: #14532d;
      color: #bbf7d0;
      border-color: #166534;
    }
  }

  @media print {
    .noprint {
      visibility: hidden !important;
    }
  }

  #placeholder {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 32px max(24px, calc(50vw - 400px));
    font-family: var(--font-sans);
    font-size: 17px;
    line-height: 1.6;
    color: var(--text);
    opacity: 0.5;
    pointer-events: none;
    user-select: none;
    z-index: 0;
    display: none;
  }

  #placeholder.visible {
    display: block;
  }

  #placeholder h1 {
    font-size: 2em;
    font-weight: 700;
    margin-bottom: 0.5em;
  }

  #placeholder h2 {
    font-size: 1.25em;
    font-weight: 600;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }

  #placeholder ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #placeholder li {
    margin-bottom: 0.5em;
  }

  #placeholder code {
    font-family: var(--font-mono);
    background-color: var(--ce-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
  }
</style>
<article contenteditable="plaintext-only" spellcheck autofocus></article>
<div id="placeholder">
  <h1>Welcome to space onURL <span style="font-weight: 100;"> (⌐■_■) </span></h1>
  <p>A minimalist text editor that lives entirely in your browser and stores everything in the URL.</p>
  <h2>Features</h2>
  <ul>
    <li>&gt;&lt; <strong>Compression</strong> - Your text gets compressed and stored in the URL</li>
    <li>&lt;-&gt; <strong>Easy Sharing</strong> - Share your notes by copying a URL or QR code</li>
    <li>{..} <strong>Code</strong> - Code blocks with syntax highlighting & code execution</li>
    <li>^_^ <strong>Continue where you left off</strong> - Your text gets saved automatically</li>
  </ul>

  <h2>Pro tips</h2>
  <ul>
    <li>( ! ) <strong>Custom Title</strong> - Start with <code># Title</code> to set the page title</li>
    <li>
      &lt;/&gt; <strong>Raw view</strong> - Switch to raw view to see the markdown source and edit it directly
    </li>
  </ul>


</div>
<div id="toolbar" class="noprint">
  <a class="toolbar-btn" href="#new" target="_blank" title="New document">
    <svg aria-hidden="true" focusable="false">
      <use xlink:href="#icon-plus"></use>
    </svg>
  </a>
  <svg display="none">
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </symbol>
  </svg>
  <button class="toolbar-btn" id="copy-url" title="Copy URL">
    <svg aria-hidden="true" focusable="false">
      <use xlink:href="#icon-copy"></use>
    </svg>
  </button>
  <button class="toolbar-btn" id="toggle-raw" title="Toggle raw/rendered view">
    <svg aria-hidden="true" focusable="false">
      <use xlink:href="#icon-code"></use>
    </svg>
  </button>
  <button class="toolbar-btn" id="toggle-theme" title="Toggle theme">
    <svg aria-hidden="true" focusable="false" id="theme-icon">
      <use xlink:href="#icon-moon"></use>
    </svg>
  </button>
  <button id="button" title="More options">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="1"></circle>
      <circle cx="12" cy="5" r="1"></circle>
      <circle cx="12" cy="19" r="1"></circle>
    </svg>
  </button>
</div>
<div id="menu" class="noprint" role="menu">
  <a class="item" id="qr" href="/qr" role="menuitem">
    <svg aria-hidden="true" focusable="false" width="22" height="22">
      <use xlink:href="#icon-qrcode"></use>
    </svg>
    Generate QR code
  </a>
  <a class="item" id="share-link" href="" role="menuitem">
    <svg aria-hidden="true" focusable="false" width="22" height="22">
      <use xlink:href="#icon-share"></use>
    </svg>
    Share document
  </a>
  <a class="item" id="save-as-html" href="" role="menuitem">
    <svg aria-hidden="true" focusable="false" width="22" height="22">
      <use xlink:href="#icon-download"></use>
    </svg>
    Save as HTML
  </a>
  <a class="item" id="save-as-text" href="" role="menuitem">
    <svg aria-hidden="true" focusable="false" width="22" height="22">
      <use xlink:href="#icon-download"></use>
    </svg>
    Save as TEXT
  </a>
  <a class="item" href="https://github.com/abhiram-ar/onURL.space" target="_blank" role="menuitem">
    <svg aria-hidden="true" focusable="false" width="22" height="22">
      <use xlink:href="#icon-github"></use>
    </svg>
    GitHub
  </a>
</div>
<div id="notification" class="noprint"></div>
<script>
  let isRawMode = false

  // Initialize theme
  const getStoredTheme = () => localStorage.getItem('theme')
  const setStoredTheme = theme => localStorage.setItem('theme', theme)

  const getPreferredTheme = () => {
    const storedTheme = getStoredTheme()
    if (storedTheme) return storedTheme
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  const setTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }
    updateThemeIcon(theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches))
  }

  const updateThemeIcon = (isDark) => {
    const icon = document.querySelector('#theme-icon use')
    icon.setAttribute('xlink:href', isDark ? '#icon-sun' : '#icon-moon')
  }

  setTheme(getPreferredTheme())

  document.getElementById('toggle-theme').addEventListener('click', () => {
    const currentTheme = getPreferredTheme()
    const newTheme = currentTheme === 'light' ? 'dark' : 'light'

    setStoredTheme(newTheme)

    if (!document.startViewTransition) {
      setTheme(newTheme)
      return
    }

    const transition = document.startViewTransition(() => {
      setTheme(newTheme)
    })

    transition.ready.then(() => {
      const { clientX, clientY } = window.event || { clientX: 0, clientY: 0 } // Fallback if no event

      // Get the button position
      const btn = document.getElementById('toggle-theme');
      const rect = btn.getBoundingClientRect();
      const x = rect.left + rect.width / 2;
      const y = rect.top + rect.height / 2;

      // Calculate the distance to the furthest corner
      const endRadius = Math.hypot(
        Math.max(x, window.innerWidth - x),
        Math.max(y, window.innerHeight - y)
      );

      document.documentElement.animate(
        {
          clipPath: [
            `circle(0px at ${x}px ${y}px)`,
            `circle(${endRadius}px at ${x}px ${y}px)`
          ],
        },
        {
          duration: 500,
          easing: "ease-out",
          pseudoElement: "::view-transition-new(root)",
        }
      );
    });
  })

  initUI()

  const article = document.querySelector('article')
  const placeholder = document.getElementById('placeholder')
  const editor = new Editor(article, parseMarkdown)

  function updatePlaceholder() {
    // Check innerHTML to detect any content including rendered elements like code blocks
    if (article.innerHTML.trim().length > 0) {
      placeholder.classList.remove('visible')
    } else {
      placeholder.classList.add('visible')
    }
  }

  article.addEventListener('input', () => {
    updatePlaceholder()
    debounce(500, save)()
  })
  article.addEventListener('blur', save)
  article.addEventListener('click', event => {
    if (event.target.tagName === 'A') window.open(event.target.getAttribute('href'), '_blank')
  })
  addEventListener('DOMContentLoaded', load)
  addEventListener('hashchange', load)
  addEventListener('load', () => new MutationObserver(save).observe(article, { attributeFilter: ['style'] }))
  addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.code === 'KeyS') {
      e.preventDefault()
      downloadHTML()
    }
  })
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
  }

  console.log('%cGitHub https://github.com/abhiram-ar/onURL.space', 'font-size: 16px; border: 1px solid lightblue; border-radius: 12px; padding: 10px 14px; ')

  async function load() {
    try {
      if (location.hash !== '') await set(location.hash)
      else {
        await set(localStorage.getItem('hash') ?? '')
        if (article.textContent) history.replaceState({}, '', await get())
      }
    } catch (e) {
      article.textContent = ''
      article.removeAttribute('style')
    }
    updateTitle()
    updatePlaceholder()
  }

  async function save() {
    const hash = await get()
    if (location.hash !== hash) history.replaceState({}, '', hash)
    try {
      localStorage.setItem('hash', hash)
    } catch (e) {
    }
    updateTitle()
  }

  async function set(hash) {
    if (!hash) return
    const [content, style] = (await decompress(hash.slice(1))).split('\x00')
    editor.set(content)
    if (style) article.setAttribute('style', style)
  }

  async function get() {
    const style = article.getAttribute('style')
    const content = getArticleContent() + (style !== null ? '\x00' + style : '')
    return '#' + await compress(content)
  }

  function getArticleContent() {
    let content = ''
    const walk = (node) => {
      if (node.nodeType === Node.TEXT_NODE) {
        content += node.textContent
      } else if (node.classList?.contains('code-editor') || node.classList?.contains('code-editor-placeholder')) {
        content += node.dataset.raw || ''
      } else if (node.childNodes) {
        node.childNodes.forEach(walk)
      }
    }
    walk(article)
    return content
  }

  function updateTitle() {
    const content = getArticleContent()
    const match = content.match(/^\n*#(.+)\n/)
    document.title = match?.[1] ?? 'OnURL.space'
  }

  async function compress(string) {
    const byteArray = new TextEncoder().encode(string)
    const stream = new CompressionStream('deflate-raw')
    const writer = stream.writable.getWriter()
    writer.write(byteArray)
    writer.close()
    const buffer = await new Response(stream.readable).arrayBuffer()
    return new Uint8Array(buffer).toBase64({ alphabet: 'base64url' })
  }

  async function decompress(b64) {
    const byteArray = Uint8Array.fromBase64(b64, { alphabet: 'base64url' })
    const stream = new DecompressionStream('deflate-raw')
    const writer = stream.writable.getWriter()
    writer.write(byteArray)
    writer.close()
    const buffer = await new Response(stream.readable).arrayBuffer()
    return new TextDecoder().decode(buffer)
  }

  function debounce(ms, fn) {
    let timer
    return (...args) => {
      clearTimeout(timer)
      timer = setTimeout(() => fn(...args), ms)
    }
  }

  async function downloadHTML() {
    updateTitle()
    const doc = document.documentElement.cloneNode(true)
    doc.querySelectorAll('script').forEach(s => s.remove())
    doc.querySelectorAll('.noprint').forEach(s => s.remove())
    doc.querySelector('article').removeAttribute('contenteditable')
    const html = '<!DOCTYPE html>\n' + doc.outerHTML

    if ('showSaveFilePicker' in window) {
      try {
        const handle = await showSaveFilePicker({
          suggestedName: document.title + '.html',
          types: [{
            description: 'HTML file',
            accept: { 'text/html': ['.html'] },
          }],
        })
        const writable = await handle.createWritable()
        await writable.write(html)
        await writable.close()
        return
      } catch (e) {
        if (e.name === 'AbortError') return
      }
    }

    const blob = new Blob([html], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = document.title + '.html'
    a.click()
    URL.revokeObjectURL(url)
  }

  async function downloadTXT() {
    updateTitle()
    const text = getArticleContent()

    if ('showSaveFilePicker' in window) {
      try {
        const handle = await showSaveFilePicker({
          suggestedName: document.title + '.txt',
          types: [{
            description: 'TEXT file',
            accept: { 'text/plain': ['.txt'] },
          }],
        })
        const writable = await handle.createWritable()
        await writable.write(text)
        await writable.close()
        return
      } catch (e) {
        if (e.name === 'AbortError') return
      }
    }

    const blob = new Blob([text], { type: 'text/plain' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = document.title + '.txt'
    a.click()
    URL.revokeObjectURL(url)
  }

  let codeEditorLoaded = false
  let codeEditorLoadPromise = null

  function loadCodeEditor() {
    if (codeEditorLoaded) return Promise.resolve()
    if (codeEditorLoadPromise) return codeEditorLoadPromise

    codeEditorLoadPromise = new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = 'code-editor.js'
      script.onload = () => {
        codeEditorLoaded = true
        resolve()
      }
      script.onerror = reject
      document.head.appendChild(script)
    })
    return codeEditorLoadPromise
  }

  function hasCodeBlocks(content) {
    return /```\w*\n[\s\S]*?\n```/.test(content)
  }

  async function createCodeEditor(rawCode) {
    await loadCodeEditor()
    return window.CodeEditor.create(rawCode, save)
  }

  function parseMarkdown() {
    // In raw mode, skip all markdown rendering
    if (isRawMode) {
      return
    }

    const input = getArticleContent()
    const frag = document.createDocumentFragment()
    const codeBlockPlaceholders = [] // Track code blocks for async loading

    let cursorPos = null
    try {
      const sel = window.getSelection()
      if (sel.rangeCount > 0) {
        let offset = 0
        const walk = (node) => {
          if (node === sel.anchorNode) {
            offset += sel.anchorOffset
            return true
          }
          if (node.nodeType === Node.TEXT_NODE) {
            offset += node.textContent.length
          } else if (node.classList?.contains('code-editor') || node.classList?.contains('code-editor-placeholder')) {
            offset += (node.dataset.raw || '').length
          } else if (node.childNodes) {
            for (const child of node.childNodes) {
              if (walk(child)) return true
            }
          }
          return false
        }
        walk(article)
        cursorPos = offset
      }
    } catch (e) { }

    const matchers = [
      { name: 'md-codeblock', re: /```[^\n]*\n[\s\S]*?\n```/y },
      { name: 'md-codeblock', re: /~~~[^\n]*\n[\s\S]*?\n~~~/y },
      { name: 'md-h1', re: /^#[ \t]+[^\n]*$/my },
      { name: 'md-h2', re: /^##[ \t]+[^\n]*$/my },
      { name: 'md-h3', re: /^###[ \t]+[^\n]*$/my },
      { name: 'md-h4', re: /^####[ \t]+[^\n]*$/my },
      { name: 'md-h5', re: /^#####[ \t]+[^\n]*$/my },
      { name: 'md-h6', re: /^######[ \t]+[^\n]*$/my },
      { name: 'md-code', re: /`[^`\n]+`/y },
      { name: 'md-backtick', re: /`+/y },
      { name: 'md-bold', re: /\*\*[^*\n]+?\*\*/y },
      { name: 'md-bold', re: /__[^_\n]+?__/y },
      { name: 'md-strike', re: /~~[^~\n]+?~~/y },
      { name: 'md-italic', re: /\*[^*\n]+?\*/y },
      { name: 'md-italic', re: /_[^_\n]+?_/y },
      { name: 'md-url', re: /https?:\/\/[^\s<>()\[\]{}"'`]+/y },
    ]

    const specials = ['`', '~', '*', '#', '_', 'h']

    let i = 0
    while (i < input.length) {
      let matched = false
      for (const m of matchers) {
        m.re.lastIndex = i
        const res = m.re.exec(input)
        if (res && res.index === i) {
          const raw = res[0]
          if (m.name === 'md-url') {
            const a = document.createElement('a')
            a.className = 'md-url'
            a.href = raw
            a.textContent = raw
            a.target = '_blank'
            a.rel = 'noopener noreferrer'
            frag.appendChild(a)
          } else if (m.name === 'md-codeblock' && /^```\w+/i.test(raw)) {
            const placeholder = document.createElement('div')
            placeholder.className = 'code-editor-placeholder'
            placeholder.dataset.raw = raw
            placeholder.style.cssText = 'min-height: 80px; background: #f6f8fa; border-radius: 8px; margin: 12px 0;'
            frag.appendChild(placeholder)
            // Track start position for cursor focus
            codeBlockPlaceholders.push({ placeholder, raw, startPos: i, endPos: i + raw.length })
          } else {
            const span = document.createElement('span')
            span.className = m.name
            span.textContent = raw
            frag.appendChild(span)
          }
          i += raw.length
          matched = true
          break
        }
      }

      if (matched) continue

      let next = input.length
      for (const ch of specials) {
        const idx = input.indexOf(ch, i)
        if (idx !== -1 && idx < next) next = idx
      }

      if (next === i) {
        frag.appendChild(document.createTextNode(input[i]))
        i++
        continue
      }

      frag.appendChild(document.createTextNode(input.slice(i, next)))
      i = next
    }

    article.textContent = ''
    article.appendChild(frag)
    article.normalize()

    const lastChild = article.lastChild
    if (lastChild?.classList?.contains('code-editor-placeholder') || lastChild?.classList?.contains('code-editor')) {
      article.appendChild(document.createTextNode('\n'))
    }

    if (codeBlockPlaceholders.length > 0) {
      loadCodeEditor().then(() => {
        let focusedEditor = null
        codeBlockPlaceholders.forEach(({ placeholder, raw, startPos, endPos }) => {
          if (placeholder.parentNode) {
            const editor = window.CodeEditor.create(raw, save)
            placeholder.parentNode.replaceChild(editor, placeholder)

            // Check if cursor was inside this code block
            if (cursorPos !== null && cursorPos >= startPos && cursorPos <= endPos) {
              focusedEditor = editor
              const textarea = editor.querySelector('.code-editor-textarea')
              if (textarea) {
                const firstNewline = raw.indexOf('\n')
                const codeStart = firstNewline + 1
                const closingFence = raw.lastIndexOf('\n```')
                const codeEnd = closingFence > 0 ? closingFence : raw.length - 3

                // Calculate position within the code content (not the raw markdown)
                const relativePos = cursorPos - startPos

                // Adjust position to be within the code body
                let posInCode = 0
                if (relativePos <= codeStart) {
                  // Cursor was in the opening fence line, place at start of code
                  posInCode = 0
                } else if (relativePos >= codeEnd) {
                  // Cursor was in or after closing fence, place at end of code
                  posInCode = textarea.value.length
                } else {
                  // Cursor was in the code body
                  posInCode = Math.min(relativePos - codeStart, textarea.value.length)
                }

                // Focus and set cursor position
                setTimeout(() => {
                  textarea.focus()
                  textarea.setSelectionRange(posInCode, posInCode)
                }, 10)
              }
            }
          }
        })
      }).catch(err => {
        console.error('Failed to load code editor:', err)
        codeBlockPlaceholders.forEach(({ placeholder, raw }) => {
          if (placeholder.parentNode) {
            const span = document.createElement('span')
            span.className = 'md-codeblock'
            span.textContent = raw
            placeholder.parentNode.replaceChild(span, placeholder)
          }
        })
      })
    }
  }

  function initUI() {
    const menu = document.querySelector('#menu')
    const button = document.querySelector('#button')
    const copyUrlBtn = document.querySelector('#copy-url')
    const toggleRawBtn = document.querySelector('#toggle-raw')
    const qr = document.querySelector('#qr')
    const shareLink = document.querySelector('#share-link')
    const saveAsHTML = document.querySelector('#save-as-html')
    const saveAsText = document.querySelector('#save-as-text')

    function hideMenu() {
      menu.classList.remove('visible')
    }

    function notify(message, icon = null, type = '') {
      const notification = document.querySelector('#notification')
      notification.className = type ? `visible ${type}` : 'visible'
      notification.innerHTML = (icon ? `<span class="toast-icon">${icon}</span>` : '') + message
      clearTimeout(notification._timer)
      notification._timer = setTimeout(() => {
        notification.classList.remove('visible')
      }, 2000)
    }

    const toastIcons = {
      copy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
      raw: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8l-4 4l4 4"/><path d="M17 8l4 4l-4 4"/><path d="M14 4l-4 16"/></svg>',
      rendered: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h10"/></svg>',
    }

    function copyURL() {
      if (!navigator.clipboard) {
        alert('Your browser does not support clipboard API')
        return
      }
      navigator.clipboard.writeText(location.href)
      notify('Link copied to clipboard', toastIcons.copy, 'success')
    }

    function toggleRawMode() {
      isRawMode = !isRawMode
      toggleRawBtn.classList.toggle('active', isRawMode)

      if (isRawMode) {
        // Switch to raw mode - show plain text
        const content = getArticleContent()
        article.textContent = content
        notify('Raw mode: Markdown disabled    ', toastIcons.raw)
      } else {
        // Switch to rendered mode - parse markdown
        parseMarkdown()
        notify('Rendered mode: Markdown enabled', toastIcons.rendered)
      }
    }

    toggleRawBtn.addEventListener('click', toggleRawMode)

    button.addEventListener('click', event => {
      menu.classList.toggle('visible')
      qr.setAttribute('href', '/qr' + location.hash)
      shareLink.setAttribute('href', location.href)
    })

    copyUrlBtn.addEventListener('click', event => {
      // Animate the icon to checkmark
      const icon = copyUrlBtn.querySelector('use')
      const originalHref = icon.getAttribute('xlink:href')
      icon.setAttribute('xlink:href', '#icon-check')

      // Revert back after 2 seconds
      setTimeout(() => {
        icon.setAttribute('xlink:href', originalHref)
      }, 2000)

      copyURL()
    })

    document.body.addEventListener('click', event => {
      let t = event.target
      if (t.closest('#menu')) return
      if (t.closest('#button')) return
      if (t.closest('#toolbar')) return
      menu.classList.remove('visible')
    })

    shareLink.addEventListener('click', event => {
      event.preventDefault()

      // Animate the icon to checkmark
      const icon = shareLink.querySelector('use')
      const originalHref = icon.getAttribute('xlink:href')
      icon.setAttribute('xlink:href', '#icon-check')

      // Revert back after 2 seconds
      setTimeout(() => {
        icon.setAttribute('xlink:href', originalHref)
      }, 2000)

      copyURL()
      hideMenu()
    })
    saveAsHTML.addEventListener('click', event => {
      event.preventDefault()
      downloadHTML()
      hideMenu()
    })
    saveAsText.addEventListener('click', event => {
      event.preventDefault()
      downloadTXT()
      hideMenu()
    })
  }

  function Editor(element, highlight) {
    const listeners = []
    const history = []
    let at = -1, prev

    const isInsideCodeEditor = () => {
      const sel = window.getSelection()
      if (!sel.anchorNode) return false
      let node = sel.anchorNode
      while (node && node !== element) {
        if (node.classList?.contains('code-editor')) return true
        node = node.parentNode
      }
      return false
    }

    const debounceHighlight = debounce(30, () => {
      if (isInsideCodeEditor()) return
      const pos = save()
      highlight(element)
      restore(pos)
    })

    const shouldRecord = (event) => {
      return !isUndo(event) && !isRedo(event)
        && event.key !== 'Meta'
        && event.key !== 'Control'
        && event.key !== 'Alt'
        && !event.key.startsWith('Arrow')
    }

    let recording = false
    const debounceRecordHistory = debounce(300, (event) => {
      if (shouldRecord(event)) {
        recordHistory()
        recording = false
      }
    })

    const on = (type, fn) => {
      listeners.push([type, fn])
      element.addEventListener(type, fn)
    }
    on('keydown', event => {
      if (event.defaultPrevented) return
      prev = toString()
      if (isUndo(event)) doUndo(event)
      if (isRedo(event)) doRedo(event)
      if (shouldRecord(event) && !recording) {
        recordHistory()
        recording = true
      }
    })
    on('keyup', event => {
      if (event.defaultPrevented) return
      if (event.isComposing) return
      if (prev !== toString()) debounceHighlight()
      debounceRecordHistory(event)
    })
    on('paste', () => setTimeout(recordHistory, 10))
    on('cut', () => setTimeout(recordHistory, 10))
    on('beforeinput', event => {
      if (event.inputType === 'historyUndo') doUndo(event)
      if (event.inputType === 'historyRedo') doRedo(event)
    })

    function save() {
      const s = getSelection()
      const pos = { start: 0, end: 0, dir: undefined }
      let { anchorNode, anchorOffset, focusNode, focusOffset } = s
      if (!anchorNode || !focusNode) throw 'error1'
      if (anchorNode === element && focusNode === element) {
        pos.start = (anchorOffset > 0 && element.textContent) ? element.textContent.length : 0
        pos.end = (focusOffset > 0 && element.textContent) ? element.textContent.length : 0
        pos.dir = (focusOffset >= anchorOffset) ? '->' : '<-'
        return pos
      }
      if (anchorNode.nodeType === Node.ELEMENT_NODE) {
        const node = document.createTextNode('')
        anchorNode.insertBefore(node, anchorNode.childNodes[anchorOffset])
        anchorNode = node
        anchorOffset = 0
      }
      if (focusNode.nodeType === Node.ELEMENT_NODE) {
        const node = document.createTextNode('')
        focusNode.insertBefore(node, focusNode.childNodes[focusOffset])
        focusNode = node
        focusOffset = 0
      }
      visit(element, el => {
        if (el === anchorNode && el === focusNode) {
          pos.start += anchorOffset
          pos.end += focusOffset
          pos.dir = anchorOffset <= focusOffset ? '->' : '<-'
          return 'stop'
        }
        if (el === anchorNode) {
          pos.start += anchorOffset
          if (!pos.dir) {
            pos.dir = '->'
          } else {
            return 'stop'
          }
        } else if (el === focusNode) {
          pos.end += focusOffset
          if (!pos.dir) {
            pos.dir = '<-'
          } else {
            return 'stop'
          }
        }
        if (el.nodeType === Node.TEXT_NODE) {
          if (pos.dir !== '->') pos.start += el.nodeValue.length
          if (pos.dir !== '<-') pos.end += el.nodeValue.length
        }
        if (el.classList?.contains('code-editor') || el.classList?.contains('code-editor-placeholder')) {
          const rawLen = (el.dataset.raw || '').length
          if (pos.dir !== '->') pos.start += rawLen
          if (pos.dir !== '<-') pos.end += rawLen
        }
      })

      element.normalize()
      return pos
    }

    function restore(pos) {
      const s = getSelection()
      let startNode, startOffset = 0
      let endNode, endOffset = 0

      if (!pos.dir) pos.dir = '->'
      if (pos.start < 0) pos.start = 0
      if (pos.end < 0) pos.end = 0

      if (pos.dir === '<-') {
        const { start, end } = pos
        pos.start = end
        pos.end = start
      }

      let current = 0

      visit(element, el => {
        if (el.classList?.contains('code-editor') || el.classList?.contains('code-editor-placeholder')) {
          const len = (el.dataset.raw || '').length
          current += len
          return
        }

        if (el.nodeType !== Node.TEXT_NODE) return

        const len = (el.nodeValue || '').length
        if (current + len >= pos.start) {
          if (!startNode) {
            startNode = el
            startOffset = pos.start - current
          }
          if (current + len >= pos.end) {
            endNode = el
            endOffset = pos.end - current
            return 'stop'
          }
        }
        current += len
      })

      if (!startNode) {
        startNode = element
        startOffset = element.childNodes.length
      }
      if (!endNode) {
        endNode = element
        endOffset = element.childNodes.length
      }

      if (pos.dir === '<-') {
        [startNode, startOffset, endNode, endOffset] = [endNode, endOffset, startNode, startOffset]
      }

      {
        const startEl = uneditable(startNode)
        if (startEl) {
          const node = document.createTextNode('')
          startEl.parentNode?.insertBefore(node, startEl.nextSibling)
          startNode = node
          startOffset = 0
        }
        const endEl = uneditable(endNode)
        if (endEl) {
          const node = document.createTextNode('')
          endEl.parentNode?.insertBefore(node, endEl.nextSibling)
          endNode = node
          endOffset = 0
        }
      }

      s.setBaseAndExtent(startNode, startOffset, endNode, endOffset)
      element.normalize()
    }

    function uneditable(node) {
      while (node && node !== element) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          if (node.getAttribute('contenteditable') === 'false') {
            return node
          }
        }
        node = node.parentNode
      }
    }

    function doUndo(event) {
      preventDefault(event)
      at--
      const record = history[at]
      if (record) {
        element.innerHTML = record.html
        restore(record.pos)
      }
      if (at < 0) at = 0
    }

    function doRedo(event) {
      preventDefault(event)
      at++
      const record = history[at]
      if (record) {
        element.innerHTML = record.html
        restore(record.pos)
      }
      if (at >= history.length) at--
    }

    function recordHistory() {
      const html = element.innerHTML
      const pos = save()
      const lastRecord = history[at]
      if (
        lastRecord
        && lastRecord.html === html
        && lastRecord.pos.start === pos.start
        && lastRecord.pos.end === pos.end
      ) return
      at++
      history[at] = { html, pos }
      history.splice(at + 1)
      const maxHistory = 10_000
      if (at > maxHistory) {
        at = maxHistory
        history.splice(0, 1)
      }
    }

    function visit(editor, visitor) {
      const queue = []
      if (editor.firstChild) queue.push(editor.firstChild)
      let el = queue.pop()
      while (el) {
        if (visitor(el) === 'stop') break
        if (el.nextSibling) queue.push(el.nextSibling)
        if (el.firstChild && !el.classList?.contains('code-editor') && !el.classList?.contains('code-editor-placeholder')) queue.push(el.firstChild)
        el = queue.pop()
      }
    }

    function isCtrl(event) {
      return event.metaKey || event.ctrlKey
    }

    function isUndo(event) {
      return isCtrl(event) && !event.shiftKey && event.code === 'KeyZ'
    }

    function isRedo(event) {
      return isCtrl(event) && event.shiftKey && event.code === 'KeyZ'
    }

    function toString() {
      return element.textContent || ''
    }

    function preventDefault(event) {
      event.preventDefault()
    }

    function getSelection() {
      return element.getRootNode().getSelection()
    }

    return {
      set(content) {
        element.textContent = content
        highlight(element)
      },
      destroy() {
        for (const [type, fn] of listeners) editor.removeEventListener(type, fn)
      },
    }
  }
</script>
<svg style="display: none" aria-hidden="true" focusable="false">
  <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-plus">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M12 5l0 14" />
    <path d="M5 12l14 0" />
  </symbol>
  <symbol id="icon-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M8 9h-1a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-8a2 2 0 0 0 -2 -2h-1" />
    <path d="M12 14v-11" />
    <path d="M9 6l3 -3l3 3" />
  </symbol>
  <symbol id="icon-qrcode" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M4 5a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1l0 -4" />
    <path d="M7 17l0 .01" />
    <path d="M14 5a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1l0 -4" />
    <path d="M7 7l0 .01" />
    <path d="M4 15a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1l0 -4" />
    <path d="M17 7l0 .01" />
    <path d="M14 14l3 0" />
    <path d="M20 14l0 .01" />
    <path d="M14 14l0 3" />
    <path d="M14 20l3 0" />
    <path d="M17 17l3 0" />
    <path d="M20 17l0 3" />
  </symbol>
  <symbol id="icon-github" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path
      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
  </symbol>
  <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path
      d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />
    <path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" />
  </symbol>
  <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
    <path d="M7 11l5 5l5 -5" />
    <path d="M12 4l0 12" />
  </symbol>
  <symbol id="icon-code" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25"
    stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
    <path d="M7 8l-4 4l4 4" />
    <path d="M17 8l4 4l-4 4" />
    <path d="M14 4l-4 16" />
  </symbol>
  <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <polyline points="20 6 9 17 4 12" />
  </symbol>
  <symbol id="icon-empty" viewBox="0 0 24 24"></symbol>
</svg>